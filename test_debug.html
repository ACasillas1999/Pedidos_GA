<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Estad√≠sticas API</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Consolas', 'Monaco', monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #4ec9b0; margin-bottom: 30px; text-align: center; }
        .test-section { background: #252526; border: 1px solid #3e3e42; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .test-section h2 { color: #569cd6; margin-bottom: 15px; font-size: 18px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; color: #9cdcfe; margin-bottom: 5px; font-size: 14px; }
        input, select { width: 100%; padding: 10px; background: #3c3c3c; border: 1px solid #555; color: #d4d4d4; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #007acc; }
        button { background: #0e639c; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; margin-right: 10px; transition: background 0.3s; }
        button:hover { background: #1177bb; }
        button.secondary { background: #3e3e42; }
        button.secondary:hover { background: #505050; }
        .response { background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 4px; padding: 15px; margin-top: 15px; max-height: 600px; overflow: auto; }
        .response pre { margin: 0; color: #d4d4d4; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; line-height: 1.6; }
        .status { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        .status.success { background: #1e8e3e; color: white; }
        .status.error { background: #c72e0d; color: white; }
        .status.info { background: #0e639c; color: white; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
        .key { color: #9cdcfe; }
        .string { color: #ce9178; }
        .number { color: #b5cea8; }
        .boolean { color: #569cd6; }
        .loading { color: #dcdcaa; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .alert { background: #3e2723; border-left: 4px solid #ff6b6b; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .alert h3 { color: #ff6b6b; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug API - Sistema de Estad√≠sticas</h1>

        <!-- Indicador de Sesi√≥n -->
        <div id="session-status" style="background: #3e3e42; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
            <span class="loading">‚è≥ Verificando sesi√≥n...</span>
        </div>

        <div class="alert" id="warning-alert">
            <h3>‚ö†Ô∏è IMPORTANTE</h3>
            <p>Si ves errores de "<!DOCTYPE..." significa que:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>‚Ä¢ No has iniciado sesi√≥n en el sistema principal</li>
                <li>‚Ä¢ Los archivos PHP tienen errores</li>
                <li>‚Ä¢ La ruta a los archivos es incorrecta</li>
            </ul>
            <p style="margin-top: 10px;"><strong>Soluci√≥n:</strong> Abre <a href="Pedidos_GA.php" target="_blank" style="color: #4ec9b0;">Pedidos_GA.php</a> e inicia sesi√≥n primero</p>
        </div>

        <div class="grid">
            <div class="test-section">
                <h2>üìä Test: Estadisticas_debug.php</h2>
                <div class="form-group">
                    <label for="est_sucursal">Sucursal:</label>
                    <select id="est_sucursal">
                        <option value="DIMEGSA" selected>DIMEGSA</option>
                        <option value="AIESA">AIESA</option>
                        <option value="DEASA">DEASA</option>
                        <option value="GABSA">GABSA</option>
                        <option value="ILUMINACION">ILUMINACION</option>
                        <option value="SEGSA">SEGSA</option>
                        <option value="FESA">FESA</option>
                        <option value="TAPATIA">TAPATIA</option>
                        <option value="VALLARTA">VALLARTA</option>
                        <option value="CODI">CODI</option>
                        <option value="QUERETARO">QUERETARO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="est_start_date">Fecha Inicial:</label>
                    <input type="date" id="est_start_date">
                </div>
                <div class="form-group">
                    <label for="est_end_date">Fecha Final:</label>
                    <input type="date" id="est_end_date">
                </div>
                <button onclick="testEstadisticas()">üöÄ Ejecutar Test</button>
                <button class="secondary" onclick="clearResponse('est_response')">üóëÔ∏è Limpiar</button>
                <div id="est_response" class="response" style="display: none;"><pre></pre></div>
            </div>

            <div class="test-section">
                <h2>üë§ Test: facturas_por_chofer_debug.php</h2>
                <div class="form-group">
                    <label for="fac_sucursal">Sucursal:</label>
                    <select id="fac_sucursal">
                        <option value="DIMEGSA" selected>DIMEGSA</option>
                        <option value="AIESA">AIESA</option>
                        <option value="DEASA">DEASA</option>
                        <option value="GABSA">GABSA</option>
                        <option value="ILUMINACION">ILUMINACION</option>
                        <option value="SEGSA">SEGSA</option>
                        <option value="FESA">FESA</option>
                        <option value="TAPATIA">TAPATIA</option>
                        <option value="VALLARTA">VALLARTA</option>
                        <option value="CODI">CODI</option>
                        <option value="QUERETARO">QUERETARO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fac_start_date">Fecha Inicial:</label>
                    <input type="date" id="fac_start_date">
                </div>
                <div class="form-group">
                    <label for="fac_end_date">Fecha Final:</label>
                    <input type="date" id="fac_end_date">
                </div>
                <button onclick="testFacturas()">üöÄ Ejecutar Test</button>
                <button class="secondary" onclick="clearResponse('fac_response')">üóëÔ∏è Limpiar</button>
                <div id="fac_response" class="response" style="display: none;"><pre></pre></div>
            </div>
        </div>

        <div class="test-section">
            <h2>‚ö° Test R√°pido: Todas las Sucursales</h2>
            <button onclick="testAllSucursales()">üîÑ Probar Todas las Sucursales</button>
            <button class="secondary" onclick="clearResponse('all_response')">üóëÔ∏è Limpiar</button>
            <div id="all_response" class="response" style="display: none;"><pre></pre></div>
        </div>
    </div>

    <script>
        window.onload = function() {
            // Configurar fechas
            const endDate = new Date();
            const startDate = new Date(endDate);
            startDate.setMonth(startDate.getMonth() - 1);
            const endStr = endDate.toISOString().slice(0, 10);
            const startStr = startDate.toISOString().slice(0, 10);
            document.getElementById('est_start_date').value = startStr;
            document.getElementById('est_end_date').value = endStr;
            document.getElementById('fac_start_date').value = startStr;
            document.getElementById('fac_end_date').value = endStr;

            // Verificar sesi√≥n
            checkSession();
        };

        function checkSession() {
            fetch('check_session.php')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('session-status');
                    const warningAlert = document.getElementById('warning-alert');

                    if (data.logged_in) {
                        statusDiv.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                <span style="font-size: 24px;">‚úÖ</span>
                                <div style="text-align: left;">
                                    <div style="color: #4ec9b0; font-size: 16px; font-weight: bold;">Sesi√≥n Activa</div>
                                    <div style="color: #9cdcfe; font-size: 13px; margin-top: 5px;">
                                        Usuario: <strong>${data.user.username}</strong> |
                                        Nombre: <strong>${data.user.nombre}</strong> |
                                        Rol: <strong>${data.user.rol}</strong> |
                                        Sucursal: <strong>${data.user.sucursal}</strong>
                                    </div>
                                    <div style="color: #808080; font-size: 11px; margin-top: 3px;">
                                        ${data.timestamp}
                                    </div>
                                </div>
                                <button onclick="checkSession()" style="padding: 8px 16px; font-size: 12px;">üîÑ Refrescar</button>
                            </div>
                        `;
                        statusDiv.style.background = '#1e4620';
                        statusDiv.style.border = '2px solid #4ec9b0';
                        warningAlert.style.display = 'none';
                    } else {
                        statusDiv.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                <span style="font-size: 24px;">‚ùå</span>
                                <div style="text-align: left;">
                                    <div style="color: #ff6b6b; font-size: 16px; font-weight: bold;">No hay sesi√≥n activa</div>
                                    <div style="color: #d4d4d4; font-size: 13px; margin-top: 5px;">
                                        Debes iniciar sesi√≥n para usar los tests de debug
                                    </div>
                                </div>
                                <a href="Pedidos_GA.php" target="_blank" style="padding: 8px 16px; background: #0e639c; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: bold;">
                                    üîê Iniciar Sesi√≥n
                                </a>
                                <button onclick="checkSession()" style="padding: 8px 16px; font-size: 12px;">üîÑ Refrescar</button>
                            </div>
                        `;
                        statusDiv.style.background = '#3e2723';
                        statusDiv.style.border = '2px solid #ff6b6b';
                        warningAlert.style.display = 'block';
                    }
                })
                .catch(error => {
                    const statusDiv = document.getElementById('session-status');
                    statusDiv.innerHTML = `
                        <div style="color: #ff6b6b;">
                            ‚ö†Ô∏è Error al verificar sesi√≥n: ${error.message}
                        </div>
                    `;
                    statusDiv.style.background = '#3e2723';
                    statusDiv.style.border = '2px solid #ff6b6b';
                });
        }

        function testEstadisticas() {
            const sucursal = document.getElementById('est_sucursal').value;
            const startDate = document.getElementById('est_start_date').value;
            const endDate = document.getElementById('est_end_date').value;
            const responseDiv = document.getElementById('est_response');
            responseDiv.style.display = 'block';
            responseDiv.querySelector('pre').innerHTML = '<span class="loading">‚è≥ Cargando...</span>';

            const url = `Estadisticas_debug.php?sucursal=${encodeURIComponent(sucursal)}&start_date=${startDate}&end_date=${endDate}`;

            fetch(url)
                .then(response => {
                    const status = response.status;
                    const contentType = response.headers.get('content-type') || '';

                    if (contentType.includes('application/json')) {
                        return response.json().then(data => ({status, data, text: null, contentType}));
                    } else {
                        return response.text().then(text => ({status, data: null, text, contentType}));
                    }
                })
                .then(({status, data, text, contentType}) => {
                    if (text) {
                        const first500 = text.substring(0, 500);
                        responseDiv.querySelector('pre').innerHTML =
                            `<span class="status error">HTTP ${status}</span>` +
                            `<span class="status info">Content-Type: ${contentType}</span>\n\n` +
                            `<span style="color: #ff6b6b; font-weight: bold;">‚ö†Ô∏è ERROR: El servidor devolvi√≥ HTML en lugar de JSON</span>\n\n` +
                            `<span style="color: #9cdcfe;">Primeras 500 caracteres:</span>\n` +
                            escapeHtml(first500) + '\n\n...\n\n' +
                            `<span style="color: #dcdcaa;">Posibles causas:</span>\n` +
                            `1. No has iniciado sesi√≥n (abre Pedidos_GA.php primero)\n` +
                            `2. Error de PHP en el archivo\n` +
                            `3. Ruta incorrecta`;
                    } else {
                        const statusClass = status === 200 ? 'success' : 'error';
                        responseDiv.querySelector('pre').innerHTML =
                            `<span class="status ${statusClass}">HTTP ${status}</span>\n\n` +
                            syntaxHighlight(JSON.stringify(data, null, 2));
                    }
                })
                .catch(error => {
                    responseDiv.querySelector('pre').innerHTML =
                        `<span class="status error">‚ùå FETCH ERROR</span>\n\n${error.message}`;
                });
        }

        function testFacturas() {
            const sucursal = document.getElementById('fac_sucursal').value;
            const startDate = document.getElementById('fac_start_date').value;
            const endDate = document.getElementById('fac_end_date').value;
            const responseDiv = document.getElementById('fac_response');
            responseDiv.style.display = 'block';
            responseDiv.querySelector('pre').innerHTML = '<span class="loading">‚è≥ Cargando...</span>';

            const url = `facturas_por_chofer_debug.php?sucursal=${encodeURIComponent(sucursal)}&start_date=${startDate}&end_date=${endDate}`;

            fetch(url)
                .then(response => {
                    const status = response.status;
                    const contentType = response.headers.get('content-type') || '';

                    if (contentType.includes('application/json')) {
                        return response.json().then(data => ({status, data, text: null, contentType}));
                    } else {
                        return response.text().then(text => ({status, data: null, text, contentType}));
                    }
                })
                .then(({status, data, text, contentType}) => {
                    if (text) {
                        const first500 = text.substring(0, 500);
                        responseDiv.querySelector('pre').innerHTML =
                            `<span class="status error">HTTP ${status}</span>` +
                            `<span class="status info">Content-Type: ${contentType}</span>\n\n` +
                            `<span style="color: #ff6b6b; font-weight: bold;">‚ö†Ô∏è ERROR: El servidor devolvi√≥ HTML en lugar de JSON</span>\n\n` +
                            `<span style="color: #9cdcfe;">Primeras 500 caracteres:</span>\n` +
                            escapeHtml(first500) + '\n\n...\n\n' +
                            `<span style="color: #dcdcaa;">Posibles causas:</span>\n` +
                            `1. No has iniciado sesi√≥n (abre Pedidos_GA.php primero)\n` +
                            `2. Error de PHP en el archivo\n` +
                            `3. Ruta incorrecta`;
                    } else {
                        const statusClass = status === 200 ? 'success' : 'error';
                        responseDiv.querySelector('pre').innerHTML =
                            `<span class="status ${statusClass}">HTTP ${status}</span>\n\n` +
                            syntaxHighlight(JSON.stringify(data, null, 2));
                    }
                })
                .catch(error => {
                    responseDiv.querySelector('pre').innerHTML =
                        `<span class="status error">‚ùå FETCH ERROR</span>\n\n${error.message}`;
                });
        }

        async function testAllSucursales() {
            const sucursales = ['AIESA', 'DEASA', 'DIMEGSA', 'GABSA', 'ILUMINACION', 'SEGSA', 'FESA', 'TAPATIA', 'VALLARTA', 'CODI', 'QUERETARO'];
            const startDate = document.getElementById('est_start_date').value;
            const endDate = document.getElementById('est_end_date').value;
            const responseDiv = document.getElementById('all_response');
            responseDiv.style.display = 'block';
            responseDiv.querySelector('pre').innerHTML = '<span class="loading">‚è≥ Probando todas las sucursales...</span>';

            let results = [];
            for (const sucursal of sucursales) {
                try {
                    const url = `Estadisticas_debug.php?sucursal=${encodeURIComponent(sucursal)}&start_date=${startDate}&end_date=${endDate}`;
                    const response = await fetch(url);
                    const contentType = response.headers.get('content-type') || '';

                    if (contentType.includes('application/json')) {
                        const data = await response.json();
                        results.push({
                            sucursal: sucursal,
                            status: response.status,
                            success: data.success || false,
                            records: data.debug?.records_returned || 0,
                            total_registros: data.debug?.total_registros_sucursal || 0,
                            error: data.error || null
                        });
                    } else {
                        results.push({
                            sucursal: sucursal,
                            status: response.status,
                            success: false,
                            error: 'Devolvi√≥ HTML en lugar de JSON (probablemente no est√°s logueado)'
                        });
                    }
                } catch (error) {
                    results.push({
                        sucursal: sucursal,
                        status: 0,
                        error: error.message
                    });
                }
            }

            responseDiv.querySelector('pre').innerHTML =
                `<span class="status info">üìä RESUMEN DE TODAS LAS SUCURSALES</span>\n\n` +
                syntaxHighlight(JSON.stringify(results, null, 2));
        }

        function clearResponse(id) {
            const div = document.getElementById(id);
            div.style.display = 'none';
            div.querySelector('pre').innerHTML = '';
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</body>
</html>
